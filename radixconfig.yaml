apiVersion: radix.equinor.com/v1
kind: RadixApplication
metadata:
  name: data-modelling-tool
spec:
  environments:
    - name: prod
      build:
        from: master
    - name: dev
      build:
        from: master
  components:
    - name: web
      image: datamodelingtool.azurecr.io/dmt/web:{imageTagName}
      alwaysPullImageOnDeploy: true
      resources:
        requests:
          memory: "256Mi"
          cpu: "1000m"
        limits:
          memory: "256Mi"
          cpu: "2000m"
      environmentConfig:
        - environment: prod
          imageTagName: production
        - environment: dev
          imageTagName: latest
      ports:
        - name: http
          port: 3000

    - name: api
      image: datamodelingtool.azurecr.io/dmt/api:{imageTagName}
      alwaysPullImageOnDeploy: true
      resources:
        requests:
          memory: "256Mi"
          cpu: "1000m"
        limits:
          memory: "256Mi"
          cpu: "2000m"
      secrets:
        - AZURE_SP_SECRET
        - SCHEDULER_REDIS_PASSWORD
        - SIMA_LICENSE
      variables:
        JOB_SERVICE_ENABLED: 1
        SCHEDULER_REDIS_PORT: 6380
        SCHEDULER_REDIS_SSL: "true"
        DMSS_API: http://dmss:5000
        ENVIRONMENT: production
        SCHEDULER_ENVS_TO_EXPORT: "PUBLIC_DMSS_API,SIMA_LICENSE"
        AZURE_JOB_SUBSCRIPTION: 14d57366-b2ae-4da8-8b75-e273c6fdabe2
        AZURE_JOB_RESOURCE_GROUP: dmt-test-containers
        AZURE_JOB_TENANT_ID: 3aa4a235-b6e2-48d5-9195-7fcf05b459b0
        AZURE_JOB_CLIENT_ID: 97a6b5bd-63fb-42c6-bb75-7e5de2394ba0
      environmentConfig:
        - environment: prod
          imageTagName: production
          variables:
            SCHEDULER_REDIS_HOST: dmt-jobStore-prod.redis.cache.windows.net
            PUBLIC_DMSS_API: https://dmss-data-modelling-tool-prod.radix.equinor.com
        - environment: dev
          imageTagName: latest
          variables:
            SCHEDULER_REDIS_HOST: dmt-jobStore-test.redis.cache.windows.net
            PUBLIC_DMSS_API: https://dmss-data-modelling-tool-dev.radix.equinor.com
      ports:
        - name: flask
          port: 5000
      publicPort: flask

    - name: dmss
      image: datamodelingtool.azurecr.io/dmss:latest
      alwaysPullImageOnDeploy: true
      resources:
        requests:
          memory: "256Mi"
          cpu: "1000m"
        limits:
          memory: "256Mi"
          cpu: "2000m"
      secrets:
        - MONGO_URI
        - SECRET_KEY
      environmentConfig:
        - environment: prod
          horizontalScaling:
            minReplicas: 2
            maxReplicas: 6
        - environment: dev
          horizontalScaling:
            minReplicas: 2
            maxReplicas: 6
      variables:
        LOGGING_LEVEL: "debug"
        AUTH_ENABLED: "True"
        ENVIRONMENT: production
        OAUTH_WELL_KNOWN: https://login.microsoftonline.com/3aa4a235-b6e2-48d5-9195-7fcf05b459b0/v2.0/.well-known/openid-configuration
        OAUTH_TOKEN_ENDPOINT: https://login.microsoftonline.com/3aa4a235-b6e2-48d5-9195-7fcf05b459b0/oauth2/v2.0/token
        OAUTH_AUTH_ENDPOINT: https://login.microsoftonline.com/3aa4a235-b6e2-48d5-9195-7fcf05b459b0/oauth2/v2.0/authorize
        OAUTH_CLIENT_ID: 97a6b5bd-63fb-42c6-bb75-7e5de2394ba0
        OAUTH_AUDIENCE: 97a6b5bd-63fb-42c6-bb75-7e5de2394ba0
        MONGO_SELF_SIGN_CA_CRT: |
          -----BEGIN CERTIFICATE-----
          MIIDJzCCAg+gAwIBAgIUUWTa1ePaavivdscS2LG8WlPexDAwDQYJKoZIhvcNAQEL
          BQAwIzELMAkGA1UEBhMCTk8xFDASBgNVBAMMC0RNVC1Sb290LUNBMB4XDTIyMDUx
          OTA5NTEyOFoXDTI1MDMwODA5NTEyOFowIzELMAkGA1UEBhMCTk8xFDASBgNVBAMM
          C0RNVC1Sb290LUNBMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAqijE
          1wyjjPPPNR6GbXeFkbJv3xvpsYrZT9pHN0ervFGU/+B/RAgiogE5avz4lLGMpI+Y
          uD42AHWmtPDS1zuked9e5KXil8Y3X6QHfj1Bv72smlh2pvw8NSc0nrZK2tUSNDO9
          snfr3bZexpJsM3N23sJLpQbOmx88bpfNiWMeCHsqcwPtKWVpZvGqFAkmuojIUl7e
          kgtWvwEwZjLE1htAu61rENs3dfzDRT30BkA2Rpl3qculCPbrKDyz3wRidYVSRMsQ
          3G9rAzSaRrwZ7A9y64uz1ek1L84EdHeQiV4w1Vd6fl3NCtAB+C9JiQGBjHKpbWr6
          hIL8KDfUtDUEl/5SYQIDAQABo1MwUTAdBgNVHQ4EFgQUaUf5zU7vHb+9puULThXa
          T5v+GawwHwYDVR0jBBgwFoAUaUf5zU7vHb+9puULThXaT5v+GawwDwYDVR0TAQH/
          BAUwAwEB/zANBgkqhkiG9w0BAQsFAAOCAQEAII8/MHIn+pDF7Rv9Fa2c1PWpHPq8
          a2GBD188moaVNjgElBEAMDiE2vKOkneioLOhE/XmK1jvIQSmieIj5O0Hdbhi0TY+
          R4gkuhkajWlHGKYK9CkYpPIM6VN7vqKCMvSg9/iyJouNvYG5/wQeWzAK3KrxLdpn
          MVY0sgIuJmZlHzRt7o/fBAg48QhtFkv54VhWm0bwDC5oM/tV0mXCp+SjPexFeKv6
          1uCA+NDSIHLSdzFw4DCYKxfw9HUb8zAdVxKk2lgSEDo5HJzMW49QdUy34uh0U2m0
          /8zKVhZUPd/6FJ/WOvVLPlF5ypz9HR4xWR26KDXoqobii1sBc4nqAU1+og==
          -----END CERTIFICATE-----
      ports:
        - name: rest
          port: 5000
      publicPort: rest


    - name: proxy
      image: datamodelingtool.azurecr.io/dmt/nginx:latest
      resources:
        requests:
          memory: "256Mi"
          cpu: "1000m"
        limits:
          memory: "256Mi"
          cpu: "2000m"
      ports:
        - name: nginx
          port: 8080
      publicPort: nginx

  dnsAppAlias:
    environment: prod
    component: proxy
